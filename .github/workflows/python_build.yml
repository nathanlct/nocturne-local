name: Build and test Python from C++
on: [push]
jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."
            - run: echo "üêß This job is now running on a ${{ runner.os }} server hosted by GitHub!"
            - run: echo "üîé The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
            - name: Check out repository code
              uses: actions/checkout@v2
            - run: echo "üí° The ${{ github.repository }} repository has been cloned to the runner."
            - run: echo "üñ•Ô∏è The workflow is now ready to test your code on the runner."
            - name: List files in the repository
              run: |
                  ls ${{ github.workspace }}
            - uses: conda-incubator/setup-miniconda@v2
              with:
                  activate-environment: nocturne
                  python-version: 3.8.11
            - name: Test Conda env
              shell: bash -l {0}
              run: |
                  conda info
                  conda env list
                  which python
            - name: Build Python library
              shell: bash -l {0}
              run: |
                  cd ${{ github.workspace }}
                  mkdir build
                  cd build
                  cmake .. -DPYTHON_LIBRARY_DIR="$(python -c "import site; print(site.getsitepackages()[0])")" \
                    -DPYTHON_EXECUTABLE="$(which python)" -Dpybind11_DIR=.
                  make
                  make install
            - name: Run Python tests
              shell: bash -l {0}
              run: |
                  cd ${{ github.workspace }}/tests
                  for file in ./*
                  do 
                    echo ""
                    echo "Running test $file"
                    python $file
                  done
            - run: echo "üçè This job's status is ${{ job.status }}."
